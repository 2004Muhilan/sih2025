<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-M-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firmware Analysis Dashboard</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: -8px">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        <span>CryptoGuard</span> Analysis
      </h1>
      <main class="dashboard-grid">
        <div class="grid-col-left">
          <section class="card upload-section" id="uploadSection">
            <div id="uploadPrompt">
              <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Binary File
              </h2>
              <p>Drop a binary file (ELF, PE, .bin) here or click to browse</p>
              <button class="button" onclick="document.getElementById('fileInput').click()">
                Choose File
              </button>
            </div>
            <div id="fileInfo" style="display: none"></div>
            <input type="file" id="fileInput" accept=".bin,.elf,.fw,.hex" style="display: none" onchange="handleFileSelect(this.files[0])"/>
          </section>
        </div>

        <div class="grid-col-right">
          <section class="card progress-section" id="progressSection" style="display: none">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
              Processing Log
            </h2>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="log-box" id="logBox"></div>
          </section>

          <section class="card results-section" id="resultsSection" style="display: none">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
              </svg>
              Analysis Complete
            </h2>
            <div class="download-buttons">
              <button class="button secondary" onclick="downloadJsonReport()">Report (JSON)</button>
              <button class="button" onclick="downloadPdfReport()">Report (PDF)</button>
            </div>
            <div id="cryptoResults"></div>
          </section>
        </div>
      </main>
    </div>

    <script>
      let fullAnalysisData = null;
      let currentFile = null;
      let currentJobId = null;

      function handleFileSelect(file) {
        if (!file) return;
        currentFile = file;
        const uploadPrompt = document.getElementById("uploadPrompt");
        const fileInfo = document.getElementById("fileInfo");
        fileInfo.innerHTML = `
          <div class="file-info-display">
              <div>
                  <strong>File:</strong> ${file.name}<br>
                  <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
              </div>
              <div class="file-actions" style="display: flex; gap: 1rem;">
                  <button class="change-btn" onclick="resetUploadUI()">Change</button>
                  <button class="button" onclick="startProcessing()">Analyze</button>
              </div>
          </div>`;
        uploadPrompt.style.display = "none";
        fileInfo.style.display = "block";
      }

      function resetUploadUI() {
        currentFile = null;
        currentJobId = null;
        document.getElementById("fileInput").value = null;
        document.getElementById("uploadPrompt").style.display = "block";
        document.getElementById("fileInfo").style.display = "none";
        document.getElementById("resultsSection").style.display = "none";
        document.getElementById("progressSection").style.display = "none";
      }

      async function startProcessing() {
        if (!currentFile) {
          alert("Please select a file first");
          return;
        }

        const progressSection = document.getElementById("progressSection");
        const resultsSection = document.getElementById("resultsSection");
        const logBox = document.getElementById("logBox");
        const progressFill = document.getElementById("progressFill");

        progressSection.style.display = "block";
        resultsSection.style.display = "none";
        logBox.innerHTML = "";
        progressFill.style.width = "0%";
        fullAnalysisData = null;

        addLog("Preparing for analysis...");
        const formData = new FormData();
        formData.append("file", currentFile);

        try {
          addLog("Uploading and queueing for analysis...");
          updateProgress(10, "UPLOADING");
          const response = await fetch("/api/jobs", { method: "POST", body: formData });
          
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "Upload failed");
          }

          currentJobId = result.jobId;
          addLog(`Job created: ${currentJobId}. Waiting for completion.`);
          await pollJobStatus(currentJobId);

          const resultResponse = await fetch(`/api/jobs/${currentJobId}/crypto-analysis`);
          if (!resultResponse.ok) {
            const errorData = await resultResponse.json();
            throw new Error(errorData.error || "Failed to retrieve results");
          }
          const finalResult = await resultResponse.json();

          addLog("Analysis complete. Displaying results.");
          updateProgress(100, "COMPLETED");

          fullAnalysisData = finalResult.raw_results; // Store the raw data for JSON download
          displayResults(finalResult, currentFile.name); // Pass the formatted data

          progressSection.style.display = "none";
          resultsSection.style.display = "block";

        } catch (error) {
          addLog(`An error occurred: ${error.message}`);
          updateProgress(100, "ERROR", true);
        }
      }

      async function pollJobStatus(jobId) {
        let status = "UPLOADED";
        while (status !== "COMPLETED" && status !== "ERROR") {
          await new Promise(resolve => setTimeout(resolve, 1500));
          const response = await fetch(`/api/jobs/${jobId}/status`);
          const jobData = await response.json();
          status = jobData.status;
          
          if (status !== "COMPLETED" && status !== "ERROR") {
             addLog(`Status: ${status}`);
          }

          let progress = 0;
          switch (status) {
            case "UPLOADED": progress = 20; break;
            case "ANALYZING": progress = 50; break;
            case "PROCESSING": progress = 80; break;
            case "COMPLETED": progress = 100; break;
          }
          updateProgress(progress, status);

          if (status === "ERROR") {
            throw new Error(jobData.error || "Job failed during processing.");
          }
        }
      }

      function addLog(message) {
        const logBox = document.getElementById("logBox");
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML += `<span>[${time}]</span> ${message}\n`;
        logBox.scrollTop = logBox.scrollHeight;
      }

      function updateProgress(value, text, isError = false) {
        const progressFill = document.getElementById("progressFill");
        progressFill.style.width = `${value}%`;
        if (isError) {
          progressFill.style.backgroundColor = "var(--danger-color)";
        } else {
          progressFill.style.backgroundColor = "var(--primary-color)";
        }
      }

      function displayResults(data, fileName) {
        const resultsDiv = document.getElementById("cryptoResults");
        
        // Extract data from the new structure
        const binaryInfo = data.binary_info || {};
        const binaryClass = data.binary_classification || {};
        const classDist = data.class_distribution || {};
        const detections = data.high_confidence_detections || [];
        const entropy = data.byte_entropy || 0;

        // --- Verdict ---
        const verdictClass = binaryClass.contains_crypto ? 'verdict-crypto' : 'verdict-no-crypto';
        const verdictText = binaryClass.contains_crypto ? 'CRYPTOGRAPHIC FUNCTIONS DETECTED' : 'NO CRYPTOGRAPHIC FUNCTIONS DETECTED';
        const verdictIcon = binaryClass.contains_crypto ? 
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><shield-alert><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></shield-alert></svg>' : 
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><shield-check><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></shield-check></svg>';
        
        let verdictHTML = `<div class="${verdictClass}">${verdictIcon} ${verdictText}</div>`;

        // --- Summary Metrics ---
        let metricsHTML = `
          <h3>Binary Summary</h3>
          <div class="metrics-grid">
            <div class="metric-item">
              <span class="metric-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                File Name
              </span>
              <span class="metric-value sub">${fileName}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                Architecture
              </span>
              <span class="metric-value">${binaryInfo.architecture || 'N/A'}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                Byte Entropy
              </span>
              <span class="metric-value">${entropy.toFixed(4)}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 20.5c.5-4.5 4-8.5 8-10"/><path d="M18 18.5c-4 1.5-8-2.5-10-8"/><path d="M2 12c1.5-4 5.5-8 10-8"/></svg>
                Total Functions
              </span>
              <span class="metric-value">${binaryInfo.total_functions || 0}</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3c0-.6-.4-1-1-1H3c-.6 0-1 .4-1 1Z"/><path d="M17 18v3c0 .6.4 1 1 1h4v-3c0-.6-.4-1-1-1h-3c-.6 0-1 .4-1 1Z"/><path d="M2 5v3c0 .6.4 1 1 1h4V6c0-.6-.4-1-1-1H3c-.6 0-1 .4-1 1Z"/><path d="M17 5v3c0 .6.4 1 1 1h4V6c0-.6-.4-1-1-1h-3c-.6 0-1 .4-1 1Z"/><path d="M7 11.5v0c0-.8.7-1.5 1.5-1.5h7c.8 0 1.5.7 1.5 1.5v0c0 .8-.7 1.5-1.5 1.5h-7c-.8 0-1.5-.7-1.5-1.5Z"/></svg>
                Crypto Functions
              </span>
              <span class="metric-value highlight">${binaryClass.crypto_functions || 0}</span>
            </div>
             <div class="metric-item">
              <span class="metric-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                Dominant Algorithm
              </span>
              <span class="metric-value sub">${binaryClass.dominant_algorithm || 'None'}</span>
            </div>
          </div>
        `;
        
        // --- Algorithm Distribution ---
        let distHTML = '<h3>Algorithm Distribution</h3>';
        const cryptoAlgos = Object.entries(classDist).filter(([key, val]) => key !== 'NON_CRYPTO' && val > 0);
        
        if (cryptoAlgos.length > 0) {
          distHTML += '<table class="algo-table"><thead><tr><th>Algorithm</th><th>Function Count</th></tr></thead><tbody>';
          cryptoAlgos.sort((a, b) => b[1] - a[1]); // Sort by count descending
          cryptoAlgos.forEach(([algo, count]) => {
            distHTML += `<tr>
              <td>${algo}</td>
              <td>${count}</td>
            </tr>`;
          });
          distHTML += '</tbody></table>';
        } else {
          distHTML += '<p>No specific cryptographic algorithms detected.</p>';
        }

        // --- High-Confidence Detections ---
        let detectionsHTML = '<h3>High-Confidence Detections</h3>';
        if (detections.length > 0) {
          detectionsHTML += '<table class="algo-table"><thead><tr><th>Function Name</th><th>Algorithm</th><th>Confidence</th></tr></thead><tbody>';
          detections.forEach(det => {
            detectionsHTML += `<tr>
              <td>${det.function_name}</td>
              <td>${det.predicted_class}</td>
              <td>${(det.confidence * 100).toFixed(1)}%</td>
            </tr>`;
          });
          detectionsHTML += '</tbody></table>';
        } else {
          detectionsHTML += '<p>No high-confidence cryptographic functions found.</p>';
        }

        // --- Combine and Render ---
        resultsDiv.innerHTML = `
          ${verdictHTML}
          ${metricsHTML}
          ${distHTML}
          ${detectionsHTML}
        `;
      }

      function downloadJsonReport() {
        if (!fullAnalysisData) {
          alert("No analysis data available.");
          return;
        }
        const blob = new Blob([JSON.stringify(fullAnalysisData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentFile.name}_analysis.json`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      function downloadPdfReport() {
        if (!currentJobId) {
          alert("Please run an analysis first.");
          return;
        }
        window.open(`/api/jobs/${currentJobId}/pdf`, '_blank');
      }

      // --- Drag and Drop Event Listeners ---
      const uploadSection = document.getElementById("uploadSection");
      ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
          uploadSection.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
      }

      uploadSection.addEventListener("dragenter", (e) => { uploadSection.classList.add("dragover"); });
      uploadSection.addEventListener("dragover", (e) => { uploadSection.classList.add("dragover"); });
      uploadSection.addEventListener("dragleave", () => { uploadSection.classList.remove("dragover"); });
      uploadSection.addEventListener("drop", (e) => {
        uploadSection.classList.remove("dragover");
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length) {
          document.getElementById("fileInput").files = files;
          handleFileSelect(files[0]);
        }
      });
    </script>
  </body>
</html>
